{% load widget_tweaks %}

{% include "common/base.html" %}

<link rel="stylesheet" href="https://codemirror.net/lib/codemirror.css">
<script src="https://codemirror.net/lib/codemirror.js"></script>
<script src="https://codemirror.net/addon/edit/matchbrackets.js"></script>
<link rel="stylesheet" href="https://codemirror.net/addon/hint/show-hint.css">
<script src="https://codemirror.net/addon/hint/show-hint.js"></script>
<script src="https://codemirror.net/mode/clike/clike.js"></script>
<style>.CodeMirror {border: 2px inset #dee;}</style>
{#<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.css">#}
{#<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.js"></script>#}



<div class="container ml-0 col-12">
    <div class = "controls form-group col-12">
    <textarea style="min-height: 800px" class="form-control" id="to_compile"></textarea>
    </div>

    <div class = "form-group col-3">
        <button class="btn btn-primary" type="submit" id="compile_button">Compile</button>
    </div>

    <div class="form-group col-3" id="status" style="display: none";></div>

    {% with 'error compiler_error compiler_output return_code stdout stderr' as list %}
        {% for name in list.split %}

        <div class="form-group col-8" id="{{ name }}_block" style="display: none;">
            <label class="control-label"  for="error">
                {% if name == 'error' %} Error {% endif %}
                {% if name == 'compiler_error' %} Compiler error {% endif %}
                {% if name == 'compiler_output' %} Compiler output {% endif %}
                {% if name == 'return_code' %} Return code {% endif %}
                {% if name == 'stdout' %} Stdout {% endif %}
                {% if name == 'stderr' %} Stderr {% endif %}
            </label>
            <div class="controls" id={{ name }}>
            </div>
        </div>

        {% endfor %}
    {% endwith %}
</div>

<script>

    var editor = CodeMirror.fromTextArea(document.getElementById('to_compile'), {
        mode: "text/x-c++src",
        lineNumbers: true,
    });

    function procResult(result)
    {
        for (const [key, value] of Object.entries(result)) {
            $("#" + key + "_block").show()
            $("#" + key).text(value)
        }
    }

    function procStatus(result)
    {
        var status = result['status'];
        var divv = $("#status");
        switch (status)
        {
        case 'PENDING':
            divv.show();
            divv.text("Task is pending...");
            break;
        case 'STARTED':
            divv.show();
            divv.text("Task is running...");
            break;
        default:
            divv.hide();
        }
    }

    function doPoll(task_id){
        $.ajax({
            type: "GET",
            url: "/paste/compile/api/",
            data: {
                task_id: task_id, // < note use of 'this' here
            },
            success: function(result)
            {
                procStatus(result)
                if (result['status'] === 'SUCCESS') {
                    procResult(result)
                    return;
                }

                setTimeout(doPoll, 500, task_id);
            },
            error: function(result) {
                alert('error');
            }
        });
    }

    $("#compile_button").click(function(e) {

        if ($("#status").is(':visible')) {
            alert('wait for finish')
            return;
        }
        $('#compiler_error_block, #compiler_output_block, #return_code_block, ' +
            '#stderr_block, #stdout_block, #error_block').hide();
        e.preventDefault();
        $.ajax({
            type: "POST",
            url: "/paste/compile/api/",
            data: {
                text: editor.getValue(), // < note use of 'this' here
            },
            success: function(result) {
                doPoll(result['task_id']);
            },
            error: function(result) {
                alert("error");
            }
        });
    });
</script>